<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="store.babel.babel.domain.report.mapper.ReportMapper">
    <resultMap id="reportCardMap" type="store.babel.babel.domain.report.dto.ReportCard">
        <id property="id" column="id"/>
        <result property="reporterId" column="reporter_id"/>
        <result property="reporterNickname" column="reporter_nickname"/>
        <result property="targetType" column="target_type"/>
        <result property="targetId" column="target_id"/>
        <result property="status" column="status"/>
        <result property="reason" column="reason"/>
        <result property="detailReason" column="detail_reason"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <insert id="createReport" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO reports(reporter_id,
                            target_type,
                            target_id,
                            reason,
                            detail_reason,
                            status)
        VALUES (#{reporterId},
                #{targetType},
                #{targetId},
                #{reason},
                #{detailReason},
                #{status});
    </insert>

    <select id="countReports">
        SELECT COUNT(r.id)
        FROM reports r
        LEFT JOIN users reporter ON r.reporter_id = reporter.id
        WHERE r.deleted_at IS NULL

        <if test="status != null">
            AND r.status = #{status}
        </if>

        <if test="targetType != null">
            AND r.target_type = #{targetType}
        </if>

        <if test="startDateTime != null and endDateTime != null">
            AND r.created_at BETWEEN #{startDateTime} AND #{endDateTime}
        </if>

        <if test="keyword != null and keyword != ''">
            AND reporter.nickname LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>

    <select id="getReports" resultMap="reportCardMap">
        SELECT
        r.id,
        r.reporter_id,
        reporter.nickname as reporter_nickname,
        r.target_type,
        r.target_id,
        r.status,
        r.reason,
        r.detail_reason,
        r.created_at
        FROM reports r
        LEFT JOIN users reporter ON r.reporter_id = reporter.id
        WHERE r.deleted_at IS NULL

        <if test="status != null">
            AND r.status = #{status}
        </if>

        <if test="targetType != null">
            AND r.target_type = #{targetType}
        </if>

        <if test="startDateTime != null and endDateTime != null">
            AND r.created_at BETWEEN #{startDateTime} AND #{endDateTime}
        </if>

        <if test="keyword != null and keyword != ''">
            AND reporter.nickname LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY
        <choose>
            <when test="sortType == 'CREATED_AT'">
                r.created_at DESC
            </when>
            <when test="sortType == 'STATUS'">
                CASE
                WHEN r.status = 'PENDING' THEN 0
                WHEN r.status = 'REJECTED' THEN 1
                ELSE 2
                END,
                r.created_at DESC
            </when>
            <otherwise>
                r.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="getDetailReason">
        SELECT r.detail_reason
        FROM reports r
        WHERE id = #{reportId};
    </select>

    <select id="countAll">
        SELECT COUNT(r.id)
        FROM reports r
        WHERE deleted_at IS NULL;
    </select>

    <select id="countPending">
        SELECT COUNT(r.id)
        FROM reports r
        WHERE deleted_at IS NULL
          AND status = 'PENDING';
    </select>

    <select id="countApproved">
        SELECT COUNT(r.id)
        FROM reports r
        WHERE deleted_at IS NULL
          AND status = 'APPROVED';
    </select>

    <select id="countRejected">
        SELECT COUNT(r.id)
        FROM reports r
        WHERE deleted_at IS NULL
          AND status = 'REJECTED';
    </select>

    <update id="approveReports">
        UPDATE reports
        SET status       = 'APPROVED',
            processed_by = #{adminId},
            processed_at = CURRENT_TIMESTAMP
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND status = 'PENDING';
    </update>

    <update id="rejectReports">
        UPDATE reports
        SET status       = 'REJECTED',
            processed_by = #{adminId},
            processed_at = CURRENT_TIMESTAMP
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND status = 'PENDING';
    </update>

    <update id="rejectApprovedReports">
        UPDATE reports
        SET status       = 'REJECTED',
            processed_by = #{adminId},
            processed_at = CURRENT_TIMESTAMP
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND status = 'APPROVED';
    </update>

    <update id="approveRejectedReports">
        UPDATE reports
        SET status       = 'APPROVED',
            processed_by = #{adminId},
            processed_at = CURRENT_TIMESTAMP
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND status = 'REJECTED';
    </update>

    <update id="resetToPending">
        UPDATE reports
        SET status       = 'PENDING',
            processed_by = NULL,
            processed_at = NULL
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND status != 'PENDING';
    </update>
</mapper>