<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <body>
        <!-- 신고 모달 Fragment -->
        <div th:fragment="reportModal(user)"
             id="reportModal"
             class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                
                <!-- 모달 헤더 -->
                <div class="flex items-center justify-between p-6 border-b">
                    <div class="flex items-center gap-2">
                        <i data-lucide="alert-triangle"
                           class="w-5 h-5 text-red-500">
                        </i>
                        <h3 class="text-lg font-bold">
                            신고하기
                        </h3>
                    </div>
                    <button onclick="closeReportModal()"
                            class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x"
                           class="w-5 h-5">
                        </i>
                    </button>
                </div>
                
                <!-- 모달 내용 -->
                <form id="reportForm"
                      onsubmit="submitReport(event)"
                      class="p-6">
                    
                    <!-- 숨겨진 필드 -->
                    <input type="hidden"
                           id="targetType"
                           name="targetType">
                    <input type="hidden"
                           id="targetId"
                           name="targetId">
                    <input type="hidden"
                           id="reporterId"
                           name="reporterId"
                           th:value="${user.id}">
                    
                    <!-- 신고 사유 선택 (Pills) -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            신고 사유를 선택해주세요
                            <span class="text-red-500">
                                *
                            </span>
                        </label>
                        
                        <div class="flex flex-wrap gap-2">
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="SPAM"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    스팸/광고
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="ABUSIVE_LANGUAGE"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    욕설/비방
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="SEXUAL_CONTENT"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    음란물/선정성
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="VIOLENCE"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    폭력적 콘텐츠
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="HATE_SPEECH"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    혐오 발언
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="FALSE_INFO"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    허위 정보
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="COPYRIGHT"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    저작권 침해
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="PRIVACY"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    개인정보 노출
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="ILLEGAL"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    불법 정보
                                </span>
                            </label>
                            
                            <label class="cursor-pointer">
                                <input type="radio"
                                       name="reason"
                                       value="ETC"
                                       class="peer hidden">
                                <span class="inline-block px-4 py-2 text-sm border rounded-full hover:bg-gray-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition">
                                    기타
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 추가 설명 (선택) -->
                    <div class="mb-6">
                        <label for="detailReason"
                               class="block text-sm font-medium text-gray-700 mb-2">
                            추가 설명 (선택)
                        </label>
                        <textarea
                                id="detailReason"
                                name="detailReason"
                                rows="4"
                                maxlength="500"
                                placeholder="신고 사유에 대한 추가 설명을 작성해주세요 (최대 500자)"
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"></textarea>
                        <div class="text-xs text-gray-500 mt-1 text-right">
                            <span id="charCount">
                                0
                            </span> / 500
                        </div>
                    </div>
                    
                    <!-- 버튼 -->
                    <div class="flex gap-3">
                        <button
                                type="button"
                                onclick="closeReportModal()"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">
                            취소
                        </button>
                        <button type="submit"
                                class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">
                            신고하기
                        </button>
                    </div>
                
                </form>
            </div>
        </div>
        
        <!-- 신고 모달 스크립트 Fragment -->
        <th:block th:fragment="reportModalScript">
            <script th:inline="javascript">
                // 모달 열기
                function openReportModal(targetType, targetId)
                {
                    document.getElementById('targetType').value = targetType;
                    document.getElementById('targetId').value = targetId;
                    document.getElementById('reportModal').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';

                    if (typeof lucide !== 'undefined')
                    {
                        lucide.createIcons();
                    }
                }

                // 모달 닫기
                function closeReportModal()
                {
                    document.getElementById('reportModal').classList.add('hidden');
                    document.getElementById('reportForm').reset();
                    document.getElementById('charCount').textContent = '0';
                    document.body.style.overflow = 'auto';
                }

                // 모달 외부 클릭 시 닫기
                document.getElementById('reportModal').addEventListener('click', function (e)
                {
                    if (e.target === this)
                    {
                        closeReportModal();
                    }
                });

                // ESC 키로 모달 닫기
                document.addEventListener('keydown', function (e)
                {
                    if (e.key === 'Escape')
                    {
                        const modal = document.getElementById('reportModal');
                        if (modal && !modal.classList.contains('hidden'))
                        {
                            closeReportModal();
                        }
                    }
                });

                // 글자 수 카운터
                document.getElementById('detailReason').addEventListener('input', function (e)
                {
                    document.getElementById('charCount').textContent = e.target.value.length;
                });

                // 신고 제출
                async function submitReport(e)
                {
                    e.preventDefault();

                    const formData = new FormData(e.target);

                    if (!formData.get('reason'))
                    {
                        alert('신고 사유를 선택해주세요!');
                        return;
                    }

                    const data = {
                        reporterId: parseInt(formData.get('reporterId')),
                        targetType: formData.get('targetType'),
                        targetId: parseInt(formData.get('targetId')),
                        reason: formData.get('reason'),
                        detailReason: formData.get('detailReason') || null
                    };

                    try
                    {
                        const response = await fetch('/api/report', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });

                        if (response.ok)
                        {
                            alert('신고가 접수되었습니다.');
                            closeReportModal();
                        } else
                        {
                            const error = await response.json();
                            alert('신고 접수에 실패했습니다: ' + (error.message || '알 수 없는 오류'));
                        }
                    }
                    catch (error)
                    {
                        console.error('Error:', error);
                        alert('신고 접수 중 오류가 발생했습니다.');
                    }
                }
            </script>
        </th:block>
    
    </body>
</html>