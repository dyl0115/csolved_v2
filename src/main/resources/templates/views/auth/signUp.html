<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Babel 회원가입</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
    </head>
    <body>
        <section class="bg-gray-100">
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="w-full max-w-md bg-white rounded-lg shadow-lg">
                    
                    <!-- 로고 -->
                    <div class="text-center p-6">
                        <div class="mx-auto bg-blue-500 rounded-full w-16 h-16 flex items-center justify-center mb-4">
                            <i data-lucide="code" class="text-white w-8 h-8"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">Babel</h1>
                        <p class="text-gray-600 mt-2">생각을 기록하고 나눌 수 있는 공간</p>
                    </div>
                    
                    <!-- 회원가입 입력 폼 -->
                    <div class="p-6">
                        <form id="signUpForm">
                            
                            <!-- 회원가입 이메일 입력창 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    이메일 주소
                                </label>
                                <input
                                        type="email"
                                        name="email"
                                        id="email"
                                        placeholder="사용할 이메일 주소"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                                >
                                <span id="email-error" class="text-red-500 text-sm mt-1 hidden"></span>
                            </div>
                            
                            <!-- 회원가입 닉네임 입력창 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    닉네임
                                </label>
                                <input
                                        type="text"
                                        name="nickname"
                                        id="nickname"
                                        placeholder="커뮤니티에서 사용할 닉네임 (2-8자)"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                                >
                                <span id="nickname-error" class="text-red-500 text-sm mt-1 hidden"></span>
                            </div>
                            
                            <!-- 회원가입 비밀번호 입력창 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    비밀번호
                                </label>
                                <input
                                        type="password"
                                        name="password"
                                        id="password"
                                        placeholder="8자 이상, 영문/숫자/특수문자 조합"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                                >
                                <span id="password-error" class="text-red-500 text-sm mt-1 hidden"></span>
                            </div>
                            
                            <!-- 회원가입 비밀번호 확인 입력창 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    비밀번호 확인
                                </label>
                                <input
                                        type="password"
                                        name="passwordConfirm"
                                        id="passwordConfirm"
                                        placeholder="비밀번호를 다시 입력해주세요"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                                >
                                <span id="passwordConfirm-error" class="text-red-500 text-sm mt-1 hidden"></span>
                            </div>
                            
                            <!-- 개인정보 처리 동의 체크박스 -->
                            <div class="mb-5">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" name="agreeTerms" id="agreeTerms" class="w-4 h-4">
                                    <label class="text-xs text-gray-600">이용약관 및 개인정보처리방침에 동의합니다</label>
                                </div>
                                <span id="agreeTerms-error" class="text-red-500 text-sm mt-1 hidden"></span>
                            </div>
                            
                            <!-- 에러 메시지 표시 영역 -->
                            <div class="mb-5">
                                <div id="errorMessage"
                                     class="p-4 text-sm text-red-700 bg-red-100 hidden rounded-lg">
                                </div>
                            </div>
                            
                            
                            <!-- 회원가입 버튼 -->
                            <button
                                    type="submit"
                                    id="submitBtn"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                                <i data-lucide="file-pen" class="w-5 h-5"></i>
                                <span>회원가입</span>
                            </button>
                        
                        </form>
                        
                        <!-- 로그인 페이지로 이동 링크 -->
                        <div class="text-center mt-4">
                            <p class="text-sm text-gray-600">
                                이미 계정이 있으신가요?
                                <a href="/auth/signIn" class="text-blue-600 hover:underline font-medium">로그인</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <script th:inline="javascript">
            lucide.createIcons();

            const email = document.getElementById('email');
            const emailError = document.getElementById('email-error');

            const nickname = document.getElementById('nickname')
            const nicknameError = document.getElementById('nickname-error');

            const password = document.getElementById('password')
            const passwordError = document.getElementById('password-error');

            const passwordConfirm = document.getElementById('passwordConfirm');
            const passwordConfirmError = document.getElementById('passwordConfirm-error');

            const agreeTerms = document.getElementById('agreeTerms');
            const agreeTermsError = document.getElementById('agreeTerms-error');

            const globalErrorMessage = document.getElementById('errorMessage');

            const inputFields = [email, nickname, password, passwordConfirm, agreeTerms];
            const errorSpans = [emailError, nicknameError, passwordError, passwordConfirmError, agreeTermsError, globalErrorMessage];

            function clearErrors()
            {
                errorSpans.forEach(errorElement =>
                    {
                        errorElement.textContent = '';
                        errorElement.classList.add('hidden');
                    }
                )

                inputFields.forEach(inputField =>
                {
                    inputField.classList.remove('border-red-500');
                })
            }

            function showError(fieldName, message)
            {
                const errorSpan = document.getElementById(`${fieldName}-error`);
                const inputField = document.getElementById(fieldName);

                if (errorSpan)
                {
                    errorSpan.textContent = message;
                    errorSpan.classList.remove('hidden');
                    errorSpan.classList.add('block');
                }

                if (inputField)
                {
                    inputField.classList.add('border-red-500');
                }
            }

            // 폼 제출 처리
            document.getElementById('signUpForm').addEventListener('submit', async (e) =>
            {
                e.preventDefault();

                // 에러 메시지 초기화
                clearErrors();

                const submitBtn = document.getElementById('submitBtn');
                const originalBtnText = submitBtn.innerHTML;

                // 버튼 비활성화
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span>처리중...</span>';

                // 폼 데이터 수집
                const formData = {
                    email: document.getElementById('email').value,
                    nickname: document.getElementById('nickname').value,
                    password: document.getElementById('password').value,
                    passwordConfirm: document.getElementById('passwordConfirm').value,
                    agreeTerms: document.getElementById('agreeTerms').checked
                };

                try
                {
                    const response = await fetch('/api/auth/signUp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (response.ok)
                    {
                        // 성공 시
                        alert('회원가입이 완료되었습니다!');
                        window.location.href = '/auth/signIn';
                    } else
                    {
                        // 실패 시 - 서버에서 받은 에러를 각 필드에 표시
                        if (data.errors)
                        {
                            // 필드별 에러 처리
                            Object.keys(data.errors).forEach(field =>
                            {
                                showError(field, data.errors[field]);
                            });
                        } else if (data.message)
                        {
                            // 전체 에러 메시지
                            globalErrorMessage.textContent = data.message;
                            globalErrorMessage.classList.remove('hidden');
                        }
                    }
                }
                catch (error)
                {
                    console.log("무슨 에러 ", error);
                    globalErrorMessage.textContent = "회원가입 중 오류가 발생했습니다. 잠시후 다시 시도해 주세요.";
                    globalErrorMessage.classList.remove('hidden');
                } finally
                {
                    // 버튼 활성화
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    lucide.createIcons();
                }
            });
        </script>
    </body>
</html>