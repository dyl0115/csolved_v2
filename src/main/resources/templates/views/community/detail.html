<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
        <title>상세 게시글</title>
        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Lucide Icons -->
        <script src="https://unpkg.com/lucide@latest"></script>
        <!-- Prism CSS -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet"/>
    </head>
    <body class="bg-gray-50">
        <!-- 네비게이션 -->
        <div th:replace="~{/layout/nav :: default-nav(${user})}"></div>
        
        <div class="container mx-auto px-4 py-8"
             th:with="post=${post},
                      bookmarked=${bookmarked},
                      answersWithComments=${answersWithComments}">
            
            <!-- 좋아요 중복 시 알림 모달 -->
            <!--            <div th:insert="~{/fragments/common/modal::alert-modal('addLikeConflictModal', '알림', '좋아요는 게시글당 한번만 누를 수 있습니다.','확인')}"></div>-->
            
            <!-- 게시글 삭제 경고 모달 -->
            <!--            <div th:insert="~{/fragments/common/modal::danger-modal('postDeleteConfirmModal', '게시글 삭제', '정말 삭제하시겠습니까?', '취소', '삭제', |deletePost('community', 'communities',${post.id})|)}"></div>-->
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-lg shadow-md mb-4">
                        <!-- 게시글 -->
                        <div class="p-6 post-content-container">
                            
                            <!-- 게시글 정보 -->
                            <div class="mb-6">
                                <!-- 제목 -->
                                <h3 class="text-2xl font-bold text-gray-800 mb-3"
                                    th:text="${post.title}">
                                    게시글 제목
                                </h3>
                                
                                <!-- 태그 -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded"
                                          th:each="tag:${post.tags}"
                                          th:text="${tag.name}">
                                        태그 명
                                    </span>
                                </div>
                                
                                <!-- 메타 정보 -->
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-500 mb-4">
                                    <!-- 카테고리 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="folder" class="w-4 h-4"></i>
                                        <span th:text="${post.categoryName}">
                                            카테고리
                                        </span>
                                    </div>
                                    
                                    <!-- 글쓴이 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                        <span th:text="${post.anonymous ? '익명' : post.authorNickname}">
                                            글쓴이
                                        </span>
                                    </div>
                                    
                                    <!-- 조회수 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                        <span th:text="${post.views}">
                                            조회수
                                        </span>
                                    </div>
                                    
                                    <!-- 작성시간 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="clock" class="w-4 h-4"></i>
                                        <span class="timeago"
                                              th:data-date="${post.createdAt}">
                                            1시간 전
                                        </span>
                                    </div>
                                    
                                    <!-- 수정여부 -->
                                    <div class="flex items-center space-x-1 text-blue-600"
                                         th:if="${post.modifiedAt}">
                                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                                        <span>
                                            수정됨
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- 수정/삭제 버튼 -->
                                <div class="flex items-center space-x-2">
                                    <a class="inline-flex items-center space-x-1 px-3 py-1.5 text-sm border border-blue-500 text-blue-500 rounded-lg hover:bg-blue-50 transition"
                                       th:if="${post.authorId == user.id}"
                                       th:href="@{/community/{id}/updateForm(id=${post.id})}">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                        <span>수정</span>
                                    </a>
                                    <button class="inline-flex items-center space-x-1 px-3 py-1.5 text-sm border border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition"
                                            data-bs-toggle="modal"
                                            data-bs-target="#postDeleteConfirmModal"
                                            th:if="${post.authorId == user.id}">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        <span>삭제</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 게시글 내용 -->
                            <div class="mb-6">
                                <div class="text-lg text-gray-700 prose max-w-none"
                                     th:utext="${post.content}">
                                    게시글 내용
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 액션 버튼들 -->
                    <div class="flex flex-wrap gap-3 mb-6">
                        <!-- 좋아요 버튼 -->
                        <button class="inline-flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow-sm"
                                id="like-button"
                                th:onclick="|addLike('community',${post.id})|">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                            <span>좋아요</span>
                            <span id="like-count"
                                  class="ml-1 font-semibold"
                                  th:text="${post.likes}">
                                0
                            </span>
                        </button>
                        
                        <!-- 답변하기 버튼 -->
                        <button class="inline-flex items-center space-x-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition shadow-sm"
                                id="toggle-answer-form">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                            <span>답변 달기</span>
                        </button>
                        
                        <!-- 북마크 버튼 -->
                        <button class="inline-flex items-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow-sm"
                                th:postId="${post.id}"
                                th:bookmarked="${bookmarked}"
                                th:onclick="|toggleBookmark(this)|">
                            <i id="bookmark-icon"
                               data-lucide="bookmark"
                               th:attr="data-lucide=${bookmarked ? 'bookmark-x' : 'bookmark'}"
                               class="w-5 h-5">
                            </i>
                            <span id="bookmark-text"
                                  th:text="${bookmarked ? '북마크 취소' : '북마크'}">
                                북마크
                            </span>
                        </button>
                    </div>
                    
                    <!-- 댓글 작성 폼 -->
                    <div class="bg-white rounded-lg shadow-md mb-6 hidden"
                         id="answer-form-card">
                        <div class="p-4"
                             th:object="${answerCreateForm}">
                            
                            <form id="answer-form"
                                  class="flex flex-col"
                                  method="post"
                                  th:action="@{/community/__${postId}__/answers}">
                                
                                <input type="hidden"
                                       id="answer-author-id"
                                       name="authorId"
                                       th:value="${user.id}"/>
                                
                                <textarea id="medium-editor"
                                          class="medium-editor w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 mb-3"
                                          rows="3"
                                          placeholder="댓글을 달아 생각을 공유해 주세요!"
                                          th:field="*{content}"
                                          th:classappend="${#fields.hasErrors('content')} ? 'border-red-500' : ''">
                                </textarea>
                                
                                <div class="text-red-500 text-sm mb-3"
                                     th:if="${#fields.hasErrors('content')}"
                                     th:errors="*{content}">
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <input class="w-4 h-4 text-gray-800 border-gray-300 rounded focus:ring-gray-800"
                                               type="checkbox"
                                               id="answer-anonymous"
                                               th:field="*{anonymous}">
                                        <label class="ml-2 text-sm text-gray-700"
                                               for="answer-anonymous">
                                            익명으로 댓글 달기
                                        </label>
                                    </div>
                                    <button type="submit"
                                            class="inline-flex items-center space-x-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition">
                                        <i data-lucide="send" class="w-4 h-4"></i>
                                        <span>등록</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 답변 리스트 -->
                    <div class="mb-6"
                         id="answer-list"
                         th:fragment="answer-list"
                         th:with="answers=${answersWithComments}">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6">
                                
                                <!-- 댓글이 없는 경우 메시지 보여주기 -->
                                <div th:if="${#lists.isEmpty(answers)}" class="text-center py-8">
                                    <i data-lucide="message-circle" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
                                    <p class="text-gray-500">
                                        댓글이 비어있습니다. 첫 번째 댓글을 작성해보세요!
                                    </p>
                                </div>
                                
                                <!-- 댓글과 대댓글 -->
                                <div class="flex gap-3 mb-6 pb-6 border-b border-gray-200 last:border-b-0 last:mb-0 last:pb-0"
                                     th:each="answer:${answers}">
                                    
                                    <!-- 댓쓴이 프로필 -->
                                    <div class="flex-shrink-0">
                                        <img class="rounded-full w-10 h-10 object-cover"
                                             th:src="${answer.anonymous ? '/assets/anonymous.jpg' : answer.authorProfileImage}"
                                             alt="프로필 이미지"/>
                                    </div>
                                    
                                    
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center flex-wrap gap-2 mb-2">
                                            <!-- 댓쓴이 닉네임 -->
                                            <span class="font-bold text-gray-800"
                                                  th:text="${answer.anonymous} ? '익명' : ${answer.authorNickname}">
                                                댓쓴이 닉네임
                                            </span>
                                            
                                            <!-- 댓글시간 -->
                                            <span class="timeago text-gray-500 text-sm"
                                                  th:data-date="${answer.createdAt}">
                                                1시간 전
                                            </span>
                                            
                                            <!-- 댓글삭제 버튼 -->
                                            <span th:if="${answer.authorId == user.id}">
                                                <button class="inline-flex items-center space-x-1 px-2 py-1 text-xs border border-red-500 text-red-500 rounded hover:bg-red-50 transition"
                                                        data-bs-toggle="modal"
                                                        th:data-bs-target="${'#answerDeleteConfirmModal' + answer.id}">
                                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                    <span>삭제</span>
                                                </button>
                                                <!-- 댓글삭제 경고 모달 -->
                                                <!--                                                <div th:replace="~{/fragments/common/modal::danger-modal(|answerDeleteConfirmModal${answer.id}|, '댓글 삭제', '정말 삭제하시겠습니까?', '취소','삭제', |deleteAnswer(${answer.id})|)}">-->
                                                <!--                                                </div>-->
                                            </span>
                                        </div>
                                        
                                        <!-- 댓글내용 -->
                                        <div class="mb-3 text-gray-700 prose max-w-none"
                                             th:utext="${answer.content}">
                                            댓글 내용
                                        </div>
                                        
                                        <!-- 대댓글 쓰기 버튼 -->
                                        <button class="inline-flex items-center space-x-1 text-sm text-blue-600 hover:text-blue-700 toggle-comment-form">
                                            <i data-lucide="corner-down-right" class="w-4 h-4"></i>
                                            <span>댓글 쓰기</span>
                                        </button>
                                        
                                        <!-- 대댓글 작성 폼 -->
                                        <div class="bg-gray-50 rounded-lg p-4 mt-3 hidden comment-form w-full">
                                            <form class="flex flex-col"
                                                  method="POST"
                                                  th:action="@{/community/{postId}/answers/{answerId}/comment(postId=${postId}, answerId=${answer.id})}"
                                                  th:object="${commentCreateForm}">
                                                
                                                <!-- 게시글 아이디  -->
                                                <input type="hidden"
                                                       th:name="postId"
                                                       th:value="${postId}"/>
                                                
                                                <!-- 답변 아이디 -->
                                                <input type="hidden"
                                                       th:name="answerId"
                                                       th:value="${answer.id}"/>
                                                
                                                <!-- 답변자 아이디 -->
                                                <input type="hidden"
                                                       th:name="authorId"
                                                       th:value="${user.id}"/>
                                                
                                                <!-- 대댓글 내용 -->
                                                <textarea
                                                        class="small-editor w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 mb-3"
                                                        rows="3"
                                                        placeholder="답변에 대한 댓글을 작성하세요!"
                                                        th:id="|small-editor${answer.id}|"
                                                        th:field="*{content}"
                                                        th:classappend="${#fields.hasErrors('content')} ? 'border-red-500' : ''">
                                                </textarea>
                                                
                                                <!-- 대댓글 오류 메시지 -->
                                                <div class="text-red-500 text-sm mb-3"
                                                     th:if="${#fields.hasErrors()}"
                                                     th:errors="*{content}">
                                                </div>
                                                
                                                <div class="flex justify-between items-center">
                                                    
                                                    <!-- 대댓글 익명/실명 선택-->
                                                    <div class="flex items-center">
                                                        <input class="w-4 h-4 text-gray-800 border-gray-300 rounded focus:ring-gray-800"
                                                               type="checkbox"
                                                               id="anonymous-checkbox-${answer.id}"
                                                               th:field="*{anonymous}">
                                                        <label class="ml-2 text-sm text-gray-700"
                                                               for="anonymous-checkbox-${answer.id}">
                                                            익명으로 댓글 달기
                                                        </label>
                                                    </div>
                                                    
                                                    <!-- 대댓글 등록 버튼 -->
                                                    <button type="submit"
                                                            class="inline-flex items-center space-x-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition">
                                                        <i data-lucide="send" class="w-4 h-4"></i>
                                                        <span>등록</span>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                        
                                        <!-- 대댓글 리스트 -->
                                        <div class="flex gap-3 mt-4 pl-6 border-l-2 border-gray-200"
                                             th:each="comment:${answer.comments}">
                                            
                                            <!-- 대댓쓴이 프로필 -->
                                            <div class="flex-shrink-0">
                                                <img class="rounded-full w-8 h-8 object-cover"
                                                     alt="프로필 이미지"
                                                     th:src="${comment.anonymous ? '/assets/anonymous.jpg' : comment.authorProfileImage}"/>
                                            </div>
                                            
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center flex-wrap gap-2 mb-2">
                                                    
                                                    <!-- 대댓쓴이 닉네임 -->
                                                    <span class="font-bold text-gray-800 text-sm"
                                                          th:text="${comment.anonymous} ? '익명' : ${comment.authorNickname}">
                                                        댓쓴이 닉네임
                                                    </span>
                                                    
                                                    <!-- 대댓글 작성시간 -->
                                                    <span class="timeago text-gray-500 text-xs"
                                                          th:data-date="${comment.createdAt}">
                                                        1시간 전
                                                    </span>
                                                    
                                                    <!-- 대댓글 삭제버튼-->
                                                    <span th:if="${comment.authorId == user.id}">
                                                        <button class="inline-flex items-center space-x-1 px-2 py-1 text-xs border border-red-500 text-red-500 rounded hover:bg-red-50 transition"
                                                                data-bs-toggle="modal"
                                                                th:data-bs-target="${'#commentDeleteConfirmModal' + comment.id}">
                                                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                            <span>삭제</span>
                                                        </button>
                                                        <!-- 댓글 삭제 경고 모달-->
                                                        <div th:insert="~{/fragments/common/modal::danger-modal(|commentDeleteConfirmModal${comment.id}|, '댓글 삭제', '정말 삭제하시겠습니까?', '취소', '삭제', |deleteComment(${comment.id})|)}"></div>
                                                    </span>
                                                </div>
                                                
                                                <!-- 대댓글 내용 -->
                                                <div class="text-gray-700 text-sm prose max-w-none"
                                                     th:utext="${comment.content}">
                                                    댓글 내용
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 사이드바 -->
                <div class="lg:col-span-1 space-y-4 sticky top-4">
                    <!-- 검색창 위젯 -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden ">
                        <div class="bg-gray-800 text-white px-4 py-3 flex items-center space-x-2">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            <h3 class="font-semibold">검색</h3>
                        </div>
                        <div class="p-4">
                            <form method="get"
                                  action="/communities">
                                <input type="hidden"
                                       name="page"
                                       value="1"/>
                                <div class="space-y-3">
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800"
                                            name="searchType">
                                        <option value="title">
                                            제목
                                        </option>
                                        <option value="author">
                                            글쓴이
                                        </option>
                                    </select>
                                    <div class="flex space-x-2">
                                        <input class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800"
                                               name="searchKeyword"
                                               type="text"
                                               placeholder="검색어 입력"/>
                                        <button class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition"
                                                type="submit">
                                            <i data-lucide="search" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 사이드 위젯-->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="bg-gray-800 text-white px-4 py-3 flex items-center space-x-2">
                            <i data-lucide="info" class="w-5 h-5"></i>
                            <h3 class="font-semibold">사이드 위젯</h3>
                        </div>
                        <div class="p-4 text-gray-600">
                            이후 기능 추가...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Prism JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <!-- Prism 지원 언어 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
        <!-- 상세 포스트 관련 JS -->
        <script src="/js/post-detail.js"></script>
        <!-- TinyMCE 에디터 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
        <!--  TinyMCE 에디터 JS-->
        <script src="/js/editor.js" defer data-upload-image-url="/api/upload-image"></script>
        <!-- Timeago.js-->
        <script src="/js/timeago.js"></script>
        <!-- 네비게이션 javascript -->
        <script th:replace="~{/layout/nav :: default-nav-scripts}"></script>
        <!-- Lucide 아이콘 초기화 -->
        <script th:inline="javascript">
        
        </script>
    </body>
</html>
