<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
        <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet"/>
        <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/quill-resize-module@2.0.8/dist/resize.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/quill-resize-module@2.0.8/dist/resize.min.css" rel="stylesheet">
        <title>게시글 작성</title>
        <style>
            @media (max-width: 1280px) {
                #resizer,
                #ai-container {
                    display: none !important;
                }

                #form-container {
                    width: 100% !important;
                    max-width: 100% !important;
                }
            }

            .chat-message {
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* 모바일 바텀시트 safe area */
            .safe-area-bottom {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
            
            /* 모바일 바텀시트 스크롤바 */
            #mobile-chat-messages::-webkit-scrollbar {
                width: 4px;
            }
            
            #mobile-chat-messages::-webkit-scrollbar-thumb {
                background-color: rgba(0, 0, 0, 0.2);
                border-radius: 2px;
            }
            
            /* FAB 애니메이션 */
            #ai-chat-fab {
                transition: transform 0.3s ease, opacity 0.3s ease;
            }
            
            /* 바텀시트 오버스크롤 방지 */
            #ai-bottom-sheet {
                overscroll-behavior: contain;
            }
        </style>
    </head>
    <body class="bg-gray-50">
        <div th:replace="~{/fragments/navigation :: navigation(${user})}"></div>
        
        <div class="max-w-[1600px] mx-auto py-8 px-4">
            <div id="main-container" class="main-container flex relative">
                <!-- 왼쪽: 게시글 작성 폼 -->
                <div id="form-container" style="width: 50%;">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <!-- 헤더 -->
                        <div class="bg-gray-900 text-white px-6 py-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="pen-tool" class="w-5 h-5"></i>
                                <h4 class="text-xl font-semibold">글 작성하기</h4>
                            </div>
                        </div>
                        
                        <!-- 본문 -->
                        <div class="p-6">
                            <!-- 카테고리 -->
                            <div class="mb-6">
                                <label for="categoryId" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="folder" class="w-4 h-4"></i>
                                        <span>카테고리</span>
                                    </div>
                                </label>
                                <select
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        id="categoryId"
                                        required>
                                    <option th:each="category:${categories}"
                                            th:text="${category.name}"
                                            th:value="${category.id}">
                                        알고리즘
                                    </option>
                                </select>
                            </div>
                            
                            <!-- 제목 -->
                            <div class="mb-6">
                                <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="type" class="w-4 h-4"></i>
                                        <span>제목</span>
                                    </div>
                                </label>
                                <input type="text"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                       id="title"
                                       placeholder="제목을 입력하세요"
                                       required>
                                <span class="text-red-500 text-sm mt-1 hidden error-message">
                                    제목 오류 메시지
                                </span>
                            </div>
                            
                            <!-- 사용자 -->
                            <input type="hidden"
                                   id="author-id"
                                   name="author-id"
                                   th:value="${user.id}"/>
                            
                            <!-- 익명/실명 토글 -->
                            <div class="mb-6">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox"
                                               id="anonymous"
                                               class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </div>
                                    <div class="flex items-center gap-2 text-gray-700">
                                        <i data-lucide="user-x" class="w-4 h-4"></i>
                                        <span class="text-sm font-medium">익명으로 작성</span>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- 태그 -->
                            <div class="mb-6">
                                <label for="tag-input" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="tag" class="w-4 h-4"></i>
                                        <span>태그</span>
                                    </div>
                                </label>
                                <div class="flex flex-wrap items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-colors min-h-[42px]"
                                     id="tags-container">
                                    
                                    <!-- 실제 태그가 전송되는 영역-->
                                    <input type="hidden" id="tag-hidden-input">
                                    
                                    <!-- 사용자가 태그를 입력하는 영역 -->
                                    <input
                                            type="text"
                                            class="tag-input flex-grow border-0 p-0 outline-none focus:ring-0"
                                            id="tag-input"
                                            placeholder="태그를 입력하고 스페이스/엔터를 누르세요">
                                </div>
                                <span class="text-red-500 text-sm mt-1 hidden error-message">
                                    태그 에러 메시지
                                </span>
                                <p class="text-sm text-gray-500 mt-1">
                                    예: 유머, 고민, 취업 ...
                                </p>
                            </div>
                            
                            <!-- 내용 -->
                            <div class="mb-6">
                                <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        <span>내용</span>
                                    </div>
                                </label>
                                
                                <textarea id="content" name="content" style="display:none;"></textarea>
                                <div id="editor"></div>
                                
                                <input type="file" id="image-file-input" style="display:none;" accept="image/*">
                                
                                <span class="text-red-500 text-sm mt-1 hidden error-message">
                                    컨텐츠 에러 메시지
                                </span>
                            </div>
                            
                            <!-- 버튼 그룹 -->
                            <div class="flex items-center justify-end gap-3 pt-4 border-t">
                                <button
                                        type="button"
                                        class="flex items-center gap-2 px-5 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                        onclick="history.back()">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                    <span>취소</span>
                                </button>
                                <button id="post-submit-btn"
                                        type="button"
                                        class="post-submit-btn flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                    <i data-lucide="check"
                                       class="w-4 h-4">
                                    </i>
                                    <span>
                                        작성완료
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 리사이저 -->
                <div id="resizer"
                     class="w-3 cursor-col-resize bg-gray-200 transition-colors flex-shrink-0 relative flex items-center justify-center z-10 hover:bg-blue-200 group">
                    <div id="resizer-bar"
                         class="absolute w-[3px] h-[50px] bg-gray-400 rounded-sm transition-all group-hover:bg-blue-500 group-hover:w-1">
                    </div>
                </div>
                
                
                <!-- 오른쪽: AI 게시글 도우미 -->
                <div id="ai-container" style="width: calc(50% - 12px);">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden sticky top-[80px] h-[calc(100vh-160px)] max-h-[900px] flex flex-col">
                        <!-- AI 도우미 헤더 -->
                        <div class="bg-blue-600 text-white px-6 py-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="bot" class="w-5 h-5"></i>
                                <h4 class="text-xl font-semibold">AI 게시글 도우미</h4>
                            </div>
                        </div>
                        
                        <!-- 채팅 메시지 영역 -->
                        <div id="chat-messages" class="flex-1 p-6 overflow-y-auto bg-gray-50"
                             style="min-height: 400px;">
                            <!-- 초기 메시지 -->
                            <div class="chat-message flex justify-start mb-4">
                                <div class="chat-bubble max-w-[80%] break-words bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm border border-gray-200">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i data-lucide="sparkles" class="w-3 h-3 text-blue-600"></i>
                                        <span class="text-xs font-medium text-blue-600">AI 도우미</span>
                                    </div>
                                    <p class="text-sm text-gray-700">안녕하세요! 게시글 작성을 도와드릴게요. 어떤 주제로 글을 쓰고 싶으신가요?</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 채팅 입력 영역 -->
                        <div class="p-4 bg-white border-t border-gray-200">
                            <div class="flex gap-2">
                                <input type="text"
                                       id="chat-input"
                                       placeholder="메시지를 입력하세요..."
                                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <button id="chat-submit-btn"
                                        class=" px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div th:replace="~{/fragments/footer :: default-footer}"></div>
    </body>
    
    <template id="user-message-template">
        <div class="chat-message flex justify-end mb-4">
            <div class="chat-bubble max-w-[80%] break-words bg-blue-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 shadow-sm">
                <p class="message-text text-sm"></p>
            </div>
        </div>
    </template>
    
    <template id="assistant-message-template">
        <div class="chat-message flex justify-start mb-4">
            <div class="chat-bubble max-w-[80%] break-words bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm border border-gray-200">
                <div class="flex items-center gap-2 mb-1">
                    <i data-lucide="sparkles" class="w-3 h-3 text-blue-600"></i>
                    <span class="text-xs font-medium text-blue-600">AI 도우미</span>
                </div>
                <p class="message-text text-sm text-gray-700"></p>
            </div>
        </div>
    </template>
    
    <template id="tag-template">
    <span class="tag-badge inline-flex items-center gap-2 px-3 py-1 mr-1 mb-1 text-sm font-medium text-white bg-blue-600 rounded-full">
        <span class="tag-text"></span>
        <button type="button"
                class="inline-flex items-center justify-center w-4 h-4 text-white hover:text-gray-200 focus:outline-none transition-colors"
                aria-label="Remove">×</button>
    </span>
    </template>
    
    <script type="module">
        import * as postAssistantUI from "/js/post/ui/postAssistantUI.js";
        import * as aiChatUI from "/js/chat/ui/postChatUI.js";
        import * as navigationUI from "/js/global/utils/navigationUI.js";
        import * as quillUI from "/js/editor/quill.js";
        import * as tagUI from "/js/global/utils/tagUI.js";
        import * as mobileBottomSheetUI from "/js/chat/ui/mobileBottomSheetUI.js";

        document.addEventListener('DOMContentLoaded', async function ()
        {
            navigationUI.init();
            quillUI.init('#editor');
            tagUI.init();             // tagUI를 먼저 초기화
            postAssistantUI.init();
            aiChatUI.init();          // 그 다음 aiChatUI 초기화
            mobileBottomSheetUI.init(); // 모바일 바텀시트 초기화
            lucide.createIcons();
        });
    </script>
</html>