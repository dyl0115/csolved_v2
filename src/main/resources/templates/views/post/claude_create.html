<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
        <title>게시글 작성</title>
        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Lucide Icons -->
        <script src="https://unpkg.com/lucide@latest"></script>
        <!-- Quill Editor CSS -->
        <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet"/>
        <!-- Quill Resize CSS -->
        <link href="https://cdn.jsdelivr.net/npm/quill-resize-module@2.0.8/dist/resize.css" rel="stylesheet">
        
        <style>
            .main-container {
                display: flex;
                position: relative;
            }

            /* 작은 화면에서는 AI 도우미 숨김 */
            @media (max-width: 1280px) {
                #resizer,
                #ai-container {
                    display: none !important;
                }

                #form-container {
                    width: 100% !important;
                    max-width: 100% !important;
                }
            }

            .resizer {
                width: 12px;
                cursor: col-resize;
                background: #e5e7eb;
                transition: background 0.2s;
                flex-shrink: 0;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
            }

            .resizer::before {
                content: '';
                position: absolute;
                width: 3px;
                height: 50px;
                background: #9ca3af;
                border-radius: 2px;
            }

            .resizer:hover {
                background: #bfdbfe;
            }

            .resizer:hover::before {
                background: #3b82f6;
                width: 4px;
            }

            .resizer.resizing {
                background: #bfdbfe;
            }

            .resizer.resizing::before {
                background: #3b82f6;
                width: 4px;
            }

            .chat-message {
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .chat-bubble {
                max-width: 80%;
                word-wrap: break-word;
            }

            .sticky-assistant {
                position: sticky;
                top: 80px;
                height: calc(100vh - 160px);
                max-height: 900px;
            }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- 네비게이션 -->
        <div th:replace="~{/fragments/navigation :: navigation(${user})}"></div>
        
        <div class="max-w-[1600px] mx-auto py-8 px-4">
            <div class="main-container">
                <!-- 왼쪽: 게시글 작성 폼 -->
                <div id="form-container" style="width: 50%;">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <!-- 헤더 -->
                        <div class="bg-gray-900 text-white px-6 py-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="pen-tool" class="w-5 h-5"></i>
                                <h4 class="text-xl font-semibold">글 작성하기</h4>
                            </div>
                        </div>
                        
                        <!-- 본문 -->
                        <div class="p-6">
                            <!-- 카테고리 -->
                            <div class="mb-6">
                                <label for="categoryId" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="folder" class="w-4 h-4"></i>
                                        <span>카테고리</span>
                                    </div>
                                </label>
                                <select
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        id="categoryId"
                                        required>
                                    <option th:each="category:${categories}"
                                            th:text="${category.name}"
                                            th:value="${category.id}">
                                        알고리즘
                                    </option>
                                </select>
                            </div>
                            
                            <!-- 제목 -->
                            <div class="mb-6">
                                <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="type" class="w-4 h-4"></i>
                                        <span>제목</span>
                                    </div>
                                </label>
                                <input type="text"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                       id="title"
                                       placeholder="제목을 입력하세요"
                                       required>
                                <span class="text-red-500 text-sm mt-1 hidden error-message">
                                    제목 오류 메시지
                                </span>
                            </div>
                            
                            <!-- 사용자 -->
                            <input type="hidden" id="authorId" name="authorId" th:value="${user.id}"/>
                            
                            <!-- 익명/실명 토글 -->
                            <div class="mb-6">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox"
                                               id="anonymous"
                                               class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </div>
                                    <div class="flex items-center gap-2 text-gray-700">
                                        <i data-lucide="user-x" class="w-4 h-4"></i>
                                        <span class="text-sm font-medium">익명으로 작성</span>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- 태그 -->
                            <div class="mb-6">
                                <label for="tag-input" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="tag" class="w-4 h-4"></i>
                                        <span>태그</span>
                                    </div>
                                </label>
                                <div class="flex flex-wrap items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-colors min-h-[42px]"
                                     id="tags-container">
                                    
                                    <!-- 실제 태그가 전송되는 영역-->
                                    <input type="hidden" id="tag-hidden-input">
                                    
                                    <!-- 사용자가 태그를 입력하는 영역 -->
                                    <input
                                            type="text"
                                            class="tag-input flex-grow border-0 p-0 outline-none focus:ring-0"
                                            id="tag-input"
                                            placeholder="태그를 입력하고 스페이스/엔터를 누르세요">
                                </div>
                                <span class="text-red-500 text-sm mt-1 hidden error-message">
                                    태그 에러 메시지
                                </span>
                                <p class="text-sm text-gray-500 mt-1">
                                    예: 유머, 고민, 취업 ...
                                </p>
                            </div>
                            
                            <!-- 내용 -->
                            <div class="mb-6">
                                <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        <span>내용</span>
                                    </div>
                                </label>
                                
                                <textarea id="content" name="content" style="display:none;"></textarea>
                                <div id="editor"></div>
                                
                                <span class="text-red-500 text-sm mt-1 hidden error-message">
                                    컨텐츠 에러 메시지
                                </span>
                            </div>
                            
                            <!-- 버튼 그룹 -->
                            <div class="flex items-center justify-end gap-3 pt-4 border-t">
                                <button
                                        type="button"
                                        class="flex items-center gap-2 px-5 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                                        onclick="history.back()">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                    <span>취소</span>
                                </button>
                                <button type="button"
                                        class="post-submit-btn flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                    <i data-lucide="check"
                                       class="w-4 h-4">
                                    </i>
                                    <span>
                                        작성완료
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 리사이저 -->
                <div id="resizer" class="resizer"></div>
                
                <!-- 오른쪽: AI 게시글 도우미 -->
                <div id="ai-container" style="width: calc(50% - 12px);">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden sticky-assistant flex flex-col">
                        <!-- AI 도우미 헤더 -->
                        <div class="bg-blue-600 text-white px-6 py-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="bot" class="w-5 h-5"></i>
                                <h4 class="text-xl font-semibold">AI 게시글 도우미</h4>
                            </div>
                        </div>
                        
                        <!-- 채팅 메시지 영역 -->
                        <div id="chat-messages" class="flex-1 p-6 overflow-y-auto bg-gray-50"
                             style="min-height: 400px;">
                            <!-- 초기 메시지 -->
                            <div class="chat-message flex justify-start mb-4">
                                <div class="chat-bubble bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm border border-gray-200">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i data-lucide="sparkles" class="w-3 h-3 text-blue-600"></i>
                                        <span class="text-xs font-medium text-blue-600">AI 도우미</span>
                                    </div>
                                    <p class="text-sm text-gray-700">안녕하세요! 게시글 작성을 도와드릴게요. 어떤 주제로 글을 쓰고 싶으신가요?</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 채팅 입력 영역 -->
                        <div class="p-4 bg-white border-t border-gray-200">
                            <div class="flex gap-2">
                                <input
                                        type="text"
                                        id="chat-input"
                                        placeholder="메시지를 입력하세요..."
                                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        onkeypress="handleChatKeyPress(event)">
                                <button
                                        onclick="sendChatMessage()"
                                        class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 푸터 -->
        <div th:replace="~{/fragments/footer :: default-footer}"></div>
    </body>
    
    <script type="module">
        import {jsonrepair} from 'https://esm.sh/jsonrepair@3.11.0';
        import {initPostUI} from "/js/post/ui/postUI.js";

        initPostUI();
        window.jsonRepair = jsonrepair;
    </script>
    
    <script th:inline="javascript">
        // Sse 커넥션
        let eventSource = null;
        let aiMessageCount = 0;
        let aiMessageTextId = null;
        // 리사이저 기능
        let isResizing = false;
        let formContainer = null;
        let aiContainer = null;
        let mainContainer = null;
        // 이전 스트리밍 데이터 추적
        let previousTitle = '';
        let previousContent = '';
        let previousTags = [];
        let previousMessage = '';
        let jsonBuffer = '';

        document.addEventListener('DOMContentLoaded', async function ()
        {
            initNavigation();
            initQuillEditor('#editor');
            lucide.createIcons();
            initResizer();
            initSseConnect();
        });

        function initResizer()
        {
            const resizer = document.getElementById('resizer');
            formContainer = document.getElementById('form-container');
            aiContainer = document.getElementById('ai-container');
            mainContainer = document.querySelector('.main-container');

            resizer.addEventListener('mousedown', (e) =>
            {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) =>
            {
                if (!isResizing) return;

                e.preventDefault();

                // 컨테이너 정보 가져오기
                const containerRect = mainContainer.getBoundingClientRect();
                const containerWidth = containerRect.width;
                const resizerWidth = 12;

                // 마우스 위치를 컨테이너 기준으로 계산
                const offsetX = e.clientX - containerRect.left;

                // 왼쪽 폼의 너비 계산 (픽셀 단위)
                let formWidth = offsetX;

                // 최소/최대 너비 제한 (30% ~ 70%)
                const minWidth = containerWidth * 0.3;
                const maxWidth = containerWidth * 0.7;

                if (formWidth < minWidth) formWidth = minWidth;
                if (formWidth > maxWidth) formWidth = maxWidth;

                // AI 컨테이너 너비 계산
                const aiWidth = containerWidth - formWidth - resizerWidth;

                // 스타일 적용
                formContainer.style.width = `${formWidth}px`;
                aiContainer.style.width = `${aiWidth}px`;
            });

            document.addEventListener('mouseup', () =>
            {
                if (isResizing)
                {
                    isResizing = false;
                    resizer.classList.remove('resizing');
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = 'auto';
                }
            });
        }

        // 채팅 기능
        function handleChatKeyPress(event)
        {
            if (event.key === 'Enter')
            {
                sendChatMessage();
            }
        }

        function addUserMessage(message)
        {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex justify-end mb-4';
            messageDiv.innerHTML = `
                <div class="chat-bubble bg-blue-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 shadow-sm">
                    <p class="text-sm">${escapeHtml(message)}</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
        }

        function addAIMessage()
        {
            aiMessageCount++;
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            aiMessageTextId = "ai-message-" + aiMessageCount;
            messageDiv.className = 'chat-message flex justify-start mb-4';
            messageDiv.innerHTML = `
                <div class="chat-bubble bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm border border-gray-200">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="sparkles" class="w-3 h-3 text-blue-600"></i>
                        <span class="text-xs font-medium text-blue-600">AI 도우미</span>
                    </div>
                    <p id="${aiMessageTextId}" class="text-sm text-gray-700">${escapeHtml('생각 중... ')}</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
            return messageDiv.id;
        }

        function escapeHtml(text)
        {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sendChatMessage()
        {
            const title = document.getElementById('title').value;
            const content = JSON.stringify(quill.getContents());
            const tags = document.getElementById('tag-hidden-input').value;
            const messageInput = document.getElementById('chat-input');

            const message = messageInput.value.trim()
            if (!message) return;

            addUserMessage(message);
            messageInput.value = '';

            addAIMessage();
            jsonBuffer = '';

            const data = {
                role: "user",
                title: title,
                content: content,
                tags: tags.split(","),
                message: message
            }

            fetch("/ai/post/message", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
        }

        function initSseConnect()
        {
            const titleInput = document.getElementById("title");
            const tagHiddenInput = document.getElementById("tag-hidden-input");

            if (eventSource == null)
            {
                eventSource = new EventSource("/ai/post/connect");
            }

            eventSource.addEventListener('message', (event) =>
            {
                {
                    let parsed;
                    jsonBuffer += event.data;
                    try
                    {
                        // 먼저 JSON 복구 시도
                        const repairedJson = window.jsonRepair(jsonBuffer);
                        parsed = JSON.parse(repairedJson);
                    }
                    catch (error)
                    {
                        // JSON 파싱 실패 시 조용히 무시 (다음 청크를 기다림)
                        return;
                    }


                    // title 처리 - 전체 값을 비교하여 변경된 경우에만 업데이트
                    if (parsed.title !== undefined && parsed.title !== previousTitle)
                    {
                        titleInput.value = parsed.title;
                        previousTitle = parsed.title;
                    }

                    // content 처리 - 새로 추가된 부분만 타이핑 (Quill 에디터)
                    let deltaOps;

                    try
                    {
                        // 1단계: parsed.content를 파싱 시도
                        const delta = JSON.parse(parsed.content);

                        if (delta?.ops && Array.isArray(delta.ops))
                        {
                            deltaOps = delta.ops;
                        }
                    }
                    catch (error)
                    {
                        // 2단계: 파싱 실패 시 repair 후 다시 파싱
                        try
                        {
                            const repairedContent = window.jsonRepair(parsed.content);
                            console.log("repaired delta: " + repairedContent);

                            // repair된 문자열을 다시 파싱
                            const delta = JSON.parse(repairedContent);

                            if (delta?.ops && Array.isArray(delta.ops))
                            {
                                deltaOps = delta.ops;
                            }
                        }
                        catch (error2)
                        {
                            console.warn("Delta repair/parse failed:", error2);
                            return;
                        }
                    }

                    if (deltaOps)
                    {
                        console.log("deltaOps: " + JSON.stringify(deltaOps));
                        quill.setContents(deltaOps);
                        previousContent = parsed.content;
                    }

                    // tags 처리 - JSON.stringify로 배열 비교
                    if (parsed.tags !== undefined)
                    {
                        const tagsStr = JSON.stringify(parsed.tags);
                        const prevTagsStr = JSON.stringify(previousTags);

                        if (tagsStr !== prevTagsStr)
                        {
                            if (Array.isArray(parsed.tags))
                            {
                                tagHiddenInput.value = parsed.tags.join(',');
                                previousTags = [...parsed.tags];
                            }
                        }
                    }

                    // message 처리 - 채팅 말풍선에 새로 추가된 부분만 타이핑
                    if (parsed.message !== undefined && parsed.message !== previousMessage)
                    {
                        const messageTextDiv = document.getElementById(aiMessageTextId);
                        messageTextDiv.textContent = parsed.message;
                        previousMessage = parsed.message;
                    }
                }
            })
        }
    </script>
    
    <!-- Quill Editor -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script src="/js/editor/quill-editor.js"></script>
    <script src="/js/editor/quill-resize.js"></script>
    
    <!-- Page Utils -->
    <script src="/js/tag.js"></script>
    <script src="/js/navigation.js"></script>
</html>