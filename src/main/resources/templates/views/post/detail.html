<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
        <title>상세 게시글</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
    </head>
    <body class="bg-gray-50">
        <!-- 네비게이션 -->
        <div th:replace="~{/fragments/navigation :: navigation(${user})}"></div>
        
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-lg shadow-md mb-4">
                        <!-- 게시글 -->
                        <div class="p-6 post-content-container">
                            <div class="mb-6">
                                
                                <div class="hidden"
                                     id="postId"
                                     th:text="${post.id}">
                                    게시글 아이디
                                </div>
                                
                                <!-- 제목과 메뉴 -->
                                <div class="flex items-start justify-between gap-4 mb-3">
                                    <!-- 제목 -->
                                    <h3 class="text-2xl font-bold text-gray-800 flex-1"
                                        th:text="${post.title}">
                                        게시글 제목
                                    </h3>
                                    
                                    <!-- 게시글 메뉴 (드롭다운) -->
                                    <div class="relative flex-shrink-0">
                                        <!-- 메뉴 버튼 -->
                                        <button onclick="toggleMenu('post-menu')"
                                                class="flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors duration-150"
                                                id="post-menu-button">
                                            <i data-lucide="ellipsis"
                                               class="w-5 h-5">
                                            </i>
                                        </button>
                                        
                                        <!-- 드롭다운 메뉴 -->
                                        <div id="post-menu"
                                             class="post-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                            <div class="py-1">
                                                <!-- 수정하기 (작성자만) -->
                                                <a th:if="${post.authorId == user.id}"
                                                   th:href="@{/post/{id}/updateForm(id=${post.id})}"
                                                   class="flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-150">
                                                    <i data-lucide="edit"
                                                       class="w-4 h-4">
                                                    </i>
                                                    <span>
                                                        수정하기
                                                    </span>
                                                </a>
                                                
                                                <!-- 삭제하기 (작성자만) -->
                                                <button th:if="${post.authorId == user.id}"
                                                        onclick="deletePost()"
                                                        class="w-full flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 hover:bg-red-50 hover:text-red-600 transition-colors duration-150">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    <span>삭제하기</span>
                                                </button>
                                                
                                                <!-- 신고하기 (작성자가 아닐 때) -->
                                                <button th:if="${post.authorId != user.id}"
                                                        th:onclick="|openReportModal('POST', ${post.id})|"
                                                        class="w-full flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors duration-150">
                                                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                                                    <span>신고하기</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 태그 -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded"
                                          th:each="tag:${post.tags}"
                                          th:text="${tag.name}">
                                        태그 명
                                    </span>
                                </div>
                                
                                <!-- 메타 정보 -->
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-500 mb-4">
                                    <!-- 카테고리 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="folder" class="w-4 h-4"></i>
                                        <span th:text="${post.categoryName}">
                                            카테고리
                                        </span>
                                    </div>
                                    
                                    <!-- 글쓴이 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                        <span th:text="${post.anonymous ? '익명' : post.authorNickname}">
                                            글쓴이
                                        </span>
                                    </div>
                                    
                                    <!-- 조회수 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                        <span th:text="${post.views}">
                                            조회수
                                        </span>
                                    </div>
                                    
                                    <!-- 작성시간 -->
                                    <div class="flex items-center space-x-1">
                                        <i data-lucide="clock" class="w-4 h-4"></i>
                                        <span class="timeago"
                                              th:data-date="${post.createdAt}">
                                            1시간 전
                                        </span>
                                    </div>
                                    
                                    <!-- 수정여부 -->
                                    <div class="flex items-center space-x-1 text-blue-600"
                                         th:if="${post.modifiedAt}">
                                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                                        <span>
                                            수정됨
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 게시글 내용 -->
                            <div class="mb-6">
                                <div class="text-lg text-gray-700 prose max-w-none"
                                     th:utext="${post.content}">
                                    게시글 내용
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 액션 버튼들 -->
                    <div class="flex flex-wrap gap-3 mb-6">
                        <!-- 좋아요 버튼 -->
                        <button class="inline-flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow-sm
                                        disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-60 disabled:shadow-none"
                                id="post-like-button"
                                onclick="addPostLike()">
                            <i data-lucide="heart"
                               class="w-5 h-5">
                            </i>
                            <span>
                                좋아요
                            </span>
                            <span id="post-like-count"
                                  class="ml-1 font-semibold"
                                  th:text="${post.likes}">
                                0
                            </span>
                        </button>
                        
                        <!-- 답변하기 버튼 -->
                        <button class="inline-flex items-center space-x-2 px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition shadow-sm"
                                id="toggle-answer-form"
                                th:onclick="|toggleForm('answer-form-card')|">
                            <i data-lucide="message-square"
                               class="w-5 h-5">
                            </i>
                            <span>
                                댓글
                            </span>
                            <span th:text="${post.answerCount}">
                                12
                            </span>
                        </button>
                        
                        <!-- 북마크 버튼 -->
                        <button id="bookmark-button"
                                class="inline-flex items-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow-sm"
                                onclick="toggleBookmark()">
                            <i id="bookmark-icon"
                               data-lucide="bookmark"
                               th:attr="data-lucide=${post.bookmarked ? 'bookmark-x' : 'bookmark'}"
                               class="w-5 h-5">
                            </i>
                            <span id="bookmark-text"
                                  th:text="${post.bookmarked ? '북마크 취소' : '북마크'}">
                                북마크
                            </span>
                        </button>
                    </div>
                    
                    <!-- 댓글 작성 폼 -->
                    <div class="bg-white rounded-lg shadow-md mb-6 hidden"
                         id="answer-form-card">
                        <div class="p-4">
                            <form id="answer-form"
                                  class="flex flex-col">
                                <input type="hidden"
                                       id="answer-author-id"
                                       name="authorId"
                                       th:value="${user.id}"/>
                                
                                <textarea id="answer-content"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 mb-3"
                                          placeholder="답변에 대한 댓글을 작성하세요!"
                                          rows="3"></textarea>
                                
                                <div id="answer-error"
                                     class="text-red-500 text-sm mb-3 hidden">
                                    댓글 에러 메시지
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <input id="answer-anonymous"
                                               class="w-4 h-4 text-gray-800 border-gray-300 rounded focus:ring-gray-800"
                                               type="checkbox">
                                        <label class="ml-2 text-sm text-gray-700"
                                               for="answer-anonymous">
                                            익명으로 댓글 달기
                                        </label>
                                    </div>
                                    <button type="button"
                                            class="inline-flex items-center space-x-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition"
                                            onclick="submitAnswer()">
                                        <i data-lucide="send" class="w-4 h-4"></i>
                                        <span>등록</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 댓글 리스트 -->
                    <div class="mb-6"
                         id="answer-list"
                         th:fragment="answer-list">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6">
                                <!-- 댓글이 없는 경우 메시지 보여주기 -->
                                <div th:if="${#lists.isEmpty(answers)}" class="text-center py-8">
                                    <i data-lucide="message-circle" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
                                    <p class="text-gray-500">
                                        댓글이 비어있습니다. 첫 번째 댓글을 작성해보세요!
                                    </p>
                                </div>
                                
                                <!-- 댓글과 대댓글 -->
                                <div class="flex gap-3 mb-6 pb-6 border-gray-200 border-l-2 border-gray-200 last:border-b-0 last:mb-0 last:pb-0"
                                     th:each="answer:${answers}">
                                    
                                    <!-- 댓쓴이 프로필 -->
                                    <div class="flex-shrink-0 ml-4">
                                        <th:block th:if="${answer.deletedAt != null}">
                                            <img class="rounded-full w-10 h-10 object-cover"
                                                 src="/assets/anonymous.jpg"
                                                 alt="프로필 이미지"/>
                                        </th:block>
                                        <th:block th:if="${answer.deletedAt == null}">
                                            <img class="rounded-full w-10 h-10 object-cover"
                                                 th:src="${answer.anonymous ? '/assets/anonymous.jpg' : answer.authorProfileImage}"
                                                 alt="프로필 이미지"/>
                                        </th:block>
                                    </div>
                                    
                                    
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-2">
                                            <!-- 댓쓴이 닉네임 -->
                                            <div class="flex items-center flex-wrap gap-2">
                                               <span class="font-bold text-gray-800"
                                                     th:classappend="${answer.deletedAt != null} ? 'opacity-50 italic' : ''">
                                                    <th:block th:if="${answer.deletedAt != null}">
                                                        (삭제)
                                                    </th:block>
                                                    <th:block th:if="${answer.deletedAt == null}"
                                                              th:text="${answer.anonymous} ? '익명' : ${answer.authorNickname}">
                                                    </th:block>
                                                </span>
                                                
                                                <!-- 댓글시간 -->
                                                <span class="timeago text-gray-500 text-sm"
                                                      th:if="${answer.deletedAt == null}"
                                                      th:data-date="${answer.createdAt}">
                                                    1시간 전
                                                </span>
                                            </div>
                                            
                                            <!-- 댓글 메뉴 (드롭다운) -->
                                            <div class="relative flex-shrink-0">
                                                <!-- 댓글 메뉴 버튼 -->
                                                <button th:if="${answer.deletedAt == null}"
                                                        th:onclick="|toggleMenu('answer-menu' + ${answer.id})|"
                                                        class="flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors duration-150"
                                                        id="answer-menu-button">
                                                    <i data-lucide="ellipsis"
                                                       class="w-5 h-5">
                                                    </i>
                                                </button>
                                                
                                                <!-- 댓글 드롭다운 메뉴 -->
                                                <div th:id="answer-menu + ${answer.id}"
                                                     class="answer-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                                    <div class="py-1">
                                                        <!-- 댓글 삭제하기 (작성자만) -->
                                                        <button th:if="${answer.authorId == user.id}"
                                                                th:onclick="|deleteAnswer(${answer.id})|"
                                                                class="w-full flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 hover:bg-red-50 hover:text-red-600 transition-colors duration-150">
                                                            <i data-lucide="trash-2"
                                                               class="w-4 h-4">
                                                            </i>
                                                            <span>
                                                                삭제하기
                                                            </span>
                                                        </button>
                                                        
                                                        <!-- 댓글 신고하기 (작성자가 아닐 때) -->
                                                        <button th:if="${answer.authorId != user.id}"
                                                                th:onclick="|openReportModal('ANSWER', ${answer.id})|"
                                                                class="w-full flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors duration-150">
                                                            <i data-lucide="alert-triangle"
                                                               class="w-4 h-4">
                                                            </i>
                                                            <span>
                                                                신고하기
                                                            </span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 댓글 내용 -->
                                        <div class="mb-3 text-gray-700 prose max-w-none break-words"
                                             th:classappend="${answer.deletedAt != null} ? 'opacity-50 italic'"
                                             th:utext="${answer.content}">
                                            댓글 내용
                                        </div>
                                        
                                        <!-- 댓글 액션 버튼들 -->
                                        <div class="flex items-center gap-2 ">
                                            <!-- 좋아요 버튼 -->
                                            <button class="group inline-flex items-center gap-1.5 py-1.5 text-sm text-gray-600 hover:text-red-500 transition-colors duration-200"
                                                    th:data-answer-id="${answer.id}"
                                                    onclick="addAnswerLike(this)">
                                                <i data-lucide="heart"
                                                   class="w-4 h-4 group-hover:fill-red-500 transition-all duration-200">
                                                </i>
                                                <span class="font-medium">
                                                    좋아요
                                                </span>
                                                <span th:id="|answer-like-count${answer.id}|"
                                                      class="font-medium"
                                                      th:text="${answer.likes}">
                                                    12
                                                </span>
                                            </button>
                                            
                                            <!-- 댓글쓰기 버튼 -->
                                            <button class="group inline-flex items-center gap-1.5 px-1.5 py-1.5 text-sm text-gray-600 hover:text-blue-500 transition-colors duration-200"
                                                    th:onclick="|toggleForm('comment-form'+${answer.id})|">
                                                <i data-lucide="message-square"
                                                   class="w-4 h-4 group-hover:fill-blue-500 transition-colors duration-200">
                                                </i>
                                                <span class="font-medium">
                                                    댓글
                                                </span>
                                                <span class="font-medium"
                                                      th:text="${answer.comments.size()}">
                                                    3
                                                </span>
                                            </button>
                                        </div>
                                        
                                        <!-- 대댓글 작성 폼 -->
                                        <div class="bg-gray-50 rounded-lg p-4 mt-3 hidden comment-form w-full"
                                             th:id="|comment-form${answer.id}|">
                                            <form class="flex flex-col">
                                                <!-- 게시글 아이디  -->
                                                <input th:id="|comment-post${answer.id}|"
                                                       type="hidden"
                                                       th:name="postId"
                                                       th:value="${postId}"/>
                                                
                                                <!-- 답변 아이디 -->
                                                <input th:id="|comment-answer${answer.id}|"
                                                       type="hidden"
                                                       th:name="answerId"
                                                       th:value="${answer.id}"/>
                                                
                                                <!-- 답변자 아이디 -->
                                                <input th:id="|comment-author${answer.id}|"
                                                       type="hidden"
                                                       th:name="authorId"
                                                       th:value="${user.id}"/>
                                                
                                                <!-- 대댓글 내용 -->
                                                <textarea
                                                        th:id="|comment-content${answer.id}|"
                                                        class="small-editor w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 mb-3"
                                                        rows="3"
                                                        placeholder="답변에 대한 댓글을 작성하세요!"></textarea>
                                                
                                                <div th:id="|comment-error${answer.id}|"
                                                     class="text-red-500 text-sm mb-3 hidden">
                                                    대댓글 오류 메시지
                                                </div>
                                                
                                                <div class="flex justify-between items-center">
                                                    <!-- 대댓글 익명/실명 선택-->
                                                    <div class="flex items-center">
                                                        <input th:id="|comment-anonymous${answer.id}|"
                                                               class="w-4 h-4 text-gray-800 border-gray-300 rounded focus:ring-gray-800"
                                                               type="checkbox">
                                                        <label class="ml-2 text-sm text-gray-700"
                                                               th:for="|comment-anonymous${answer.id}|">
                                                            익명으로 댓글 달기
                                                        </label>
                                                    </div>
                                                    
                                                    <!-- 대댓글 등록 버튼 -->
                                                    <button type="button"
                                                            class="inline-flex items-center space-x-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition"
                                                            th:onclick="|submitComment(${answer.id})|">
                                                        <i data-lucide="send" class="w-4 h-4"></i>
                                                        <span>등록</span>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                        
                                        <!-- 대댓글 리스트 -->
                                        <div class="flex gap-3 mt-4 pb-4 pl-6 border-gray-200 border-l-2 border-gray-200"
                                             th:each="comment:${answer.comments}">
                                            
                                            <!-- 대댓쓴이 프로필 -->
                                            <div class="flex-shrink-0">
                                                <img class="rounded-full w-8 h-8 object-cover"
                                                     alt="프로필 이미지"
                                                     th:src="${comment.anonymous ? '/assets/anonymous.jpg' : comment.authorProfileImage}"/>
                                            </div>
                                            
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center flex-wrap gap-2">
                                                        <!-- 대댓쓴이 닉네임 -->
                                                        <span class="font-bold text-gray-800 text-sm"
                                                              th:text="${comment.anonymous} ? '익명' : ${comment.authorNickname}">
                                                            댓쓴이 닉네임
                                                        </span>
                                                        
                                                        <!-- 대댓글 작성시간 -->
                                                        <span class="timeago text-gray-500 text-xs"
                                                              th:data-date="${comment.createdAt}">
                                                        1시간 전
                                                    </span>
                                                    </div>
                                                    
                                                    <!-- 대댓글 메뉴 (드롭다운) -->
                                                    <div class="relative flex-shrink-0">
                                                        <!-- 대댓글 메뉴 버튼 -->
                                                        <button th:onclick="|toggleMenu('comment-menu' + ${comment.id})|"
                                                                class="flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors duration-150"
                                                                id="comment-menu-button">
                                                            <i data-lucide="ellipsis"
                                                               class="w-5 h-5">
                                                            </i>
                                                        </button>
                                                        
                                                        <!-- 댓글 드롭다운 메뉴 -->
                                                        <div th:id="comment-menu + ${comment.id}"
                                                             class="comment-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                                            <div class="py-1">
                                                                <!-- 댓글 삭제하기 (작성자만) -->
                                                                <button th:if="${comment.authorId == user.id}"
                                                                        th:onclick="|deleteComment(${comment.id})|"
                                                                        class="w-full flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 hover:bg-red-50 hover:text-red-600 transition-colors duration-150">
                                                                    <i data-lucide="trash-2"
                                                                       class="w-4 h-4">
                                                                    </i>
                                                                    <span>
                                                                        삭제하기
                                                                    </span>
                                                                </button>
                                                                
                                                                <!-- 댓글 신고하기 (작성자가 아닐 때) -->
                                                                <button th:if="${comment.authorId != user.id}"
                                                                        th:onclick="|openReportModal('COMMENT', ${comment.id})|"
                                                                        class="w-full flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors duration-150">
                                                                    <i data-lucide="alert-triangle"
                                                                       class="w-4 h-4">
                                                                    </i>
                                                                    <span>
                                                                        신고하기
                                                                    </span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 대댓글 내용 -->
                                                <div class="text-gray-700 text-sm prose max-w-none"
                                                     th:utext="${comment.content}">
                                                    댓글 내용
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 사이드바 -->
                <div class="lg:col-span-1 space-y-4 sticky top-4">
                    <!-- 검색창 위젯 -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden ">
                        <div class="bg-gray-800 text-white px-4 py-3 flex items-center space-x-2">
                            <i data-lucide="search"
                               class="w-5 h-5"></i>
                            <h3 class="font-semibold">
                                검색
                            </h3>
                        </div>
                        <div class="p-4">
                            <form method="get"
                                  action="/post/list">
                                <input type="hidden"
                                       name="page"
                                       value="1"/>
                                <div class="space-y-3">
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800"
                                            name="searchType">
                                        <option value="title">
                                            제목
                                        </option>
                                        <option value="author">
                                            글쓴이
                                        </option>
                                    </select>
                                    <div class="flex space-x-2">
                                        <input class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800"
                                               name="searchKeyword"
                                               type="text"
                                               placeholder="검색어 입력"/>
                                        <button class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition"
                                                type="submit">
                                            <i data-lucide="search" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 사이드 위젯-->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="bg-gray-800 text-white px-4 py-3 flex items-center space-x-2">
                            <i data-lucide="info" class="w-5 h-5"></i>
                            <h3 class="font-semibold">사이드 위젯</h3>
                        </div>
                        <div class="p-4 text-gray-600">
                            이후 기능 추가...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div th:replace="~{/fragments/footer :: default-footer}"></div>
        <div th:replace="~{/fragments/report-modal :: reportModal(${user})}"></div>
        <div th:replace="~{/fragments/report-modal :: reportModalScript}"></div>
    </body>
    <script th:inline="javascript">

        <!-- TODO: 이후 전역변수를 활용한 방식으로 리팩토링 하기 -->
        const uiState = {
            openMenu: null,
            openForm: null,
        }

        document.addEventListener('DOMContentLoaded', async function ()
        {
            initNavigation();
            lucide.createIcons();
        });

        function toggleForm(formId)
        {
            const form = document.getElementById(formId);

            if (uiState.openForm && uiState.openForm !== form)
            {
                uiState.openForm.classList.add('hidden');
            }

            form.classList.toggle('hidden');
            uiState.openForm = form.classList.contains('hidden') ? null : form;

            lucide.createIcons();
        }

        async function toggleAnswerForm()
        {
            const commentFormCards = document.querySelectorAll('.comment-form');
            commentFormCards.forEach(formCard => formCard.classList.add('hidden'));

            const answerFormCard = document.getElementById('answer-form-card');
            answerFormCard.classList.toggle('hidden');


        }

        async function toggleCommentForm(button)
        {
            const answerFormCard = document.getElementById('answer-form-card');
            answerFormCard.classList.add('hidden');

            const commentFormCards = document.querySelectorAll('.comment-form');
            commentFormCards.forEach(formCard => formCard.classList.add('hidden'));

            const commentForm = button.nextElementSibling;
            commentForm.classList.toggle('hidden');
        }

        async function submitComment(answerId)
        {
            const postId = document.getElementById('postId').textContent;
            const createCommentUrl = `/api/comment`;
            const getPostRedirectUrl = `/post/${postId}?skipView=true`;
            const commentAuthorId = document.getElementById(`comment-author${answerId}`).value;
            const commentContent = document.getElementById(`comment-content${answerId}`).value;
            const commentAnonymous = document.getElementById(`comment-anonymous${answerId}`).checked;
            const commentError = document.getElementById(`comment-error${answerId}`);

            const request = {
                postId: parseInt(postId),
                answerId: parseInt(answerId),
                authorId: parseInt(commentAuthorId),
                content: commentContent,
                anonymous: commentAnonymous
            }

            try
            {
                const response = await fetch(createCommentUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });

                if (response.ok)
                {
                    window.location.href = getPostRedirectUrl;
                } else
                {
                    const errorData = await response.json();
                    commentError.classList.toggle('hidden');
                    commentError.textContent = errorData.message || '알 수 없는 오류가 발생했습니다.';
                }
            }
            catch (error)
            {
                console.error('Error:', error);
                alert('서버와의 통신 중 오류가 발생했습니다.');
            }
        }

        async function submitAnswer()
        {
            const postId = document.getElementById('postId').textContent;
            const createAnswerUrl = `/api/answer`;
            const getPostRedirectUrl = `/post/${postId}?skipView=true`;
            const answerAuthorId = document.getElementById('answer-author-id').value;
            const answerAnonymous = document.getElementById('answer-anonymous').checked;
            const answerContent = document.getElementById('answer-content').value;
            const answerError = document.getElementById('answer-error');

            const request = {
                postId: parseInt(postId),
                authorId: parseInt(answerAuthorId),
                anonymous: answerAnonymous,
                content: answerContent,
            }

            try
            {
                const response = await fetch(createAnswerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });

                if (response.ok)
                {
                    window.location.href = getPostRedirectUrl;
                } else
                {
                    const errorData = await response.json();
                    answerError.classList.toggle('hidden');
                    answerError.textContent = errorData.message || '알 수 없는 오류가 발생했습니다.';
                }
            }
            catch (error)
            {
                console.error('Error:', error);
                alert('서버와의 통신 중 오류가 발생했습니다.');
            }
        }

        async function deleteComment(commentId)
        {
            const postId = document.getElementById('postId').textContent;
            const requestUrl = `/api/comment/${commentId}`;
            const redirectUrl = `/post/${postId}?skipView=true`;

            if (confirm('댓글을 삭제하시겠습니까?'))
            {
                try
                {
                    const response = await fetch(requestUrl, {
                        method: 'DELETE'
                    });

                    if (response.ok)
                    {
                        window.location.href = redirectUrl;
                    } else
                    {
                        const errorData = await response.json();
                        alert(errorData.message || '알 수 없는 오류가 발생했습니다.');
                    }
                }
                catch (error)
                {
                    console.error('Error:', error);
                    alert('서버와의 통신 중 오류가 발생했습니다.');
                }
            }
        }

        async function deleteAnswer(answerId)
        {
            const postId = document.getElementById('postId').textContent;
            const requestUrl = `/api/answer/${answerId}`;
            const redirectUrl = `/post/${postId}?skipView=true`;

            if (confirm('댓글을 삭제하시겠습니까?'))
            {
                try
                {
                    const response = await fetch(requestUrl, {
                        method: 'DELETE'
                    });

                    if (response.ok)
                    {
                        window.location.href = redirectUrl;
                    } else
                    {
                        const errorData = await response.json();
                        alert(errorData.message || '알 수 없는 오류가 발생했습니다.');
                    }
                }
                catch (error)
                {
                    console.error('Error:', error);
                    alert('서버와의 통신 중 오류가 발생했습니다.');
                }
            }
        }

        async function deletePost()
        {
            const postId = document.getElementById('postId').textContent;
            const url = `/api/post/${postId}`;

            if (confirm("게시글을 삭제하겠습니까?"))
            {
                try
                {
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    if (response.ok)
                    {
                        alert("삭제가 완료되었습니다.");
                        window.location.href = '/post/list?page=1';
                    } else
                    {
                        const errorData = await response.json();
                        alert('삭제 실패: ' + (errorData.message || '알 수 없는 오류가 발생했습니다.'));
                    }
                }
                catch (error)
                {
                    console.error('Error:', error);
                    alert('서버와의 통신 중 오류가 발생했습니다.');
                }
            }
        }

        async function addPostLike()
        {
            const postId = document.getElementById('postId').textContent;
            const likeButton = document.getElementById('post-like-button');
            const likeCount = document.getElementById('post-like-count');
            let likeCountInt = parseInt(likeCount.textContent, 10) || 0;

            try
            {
                const response = await fetch(`/api/post/${postId}/likes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok)
                {
                    likeCount.textContent = ++likeCountInt;
                    likeButton.disabled = true;

                } else
                {
                    const errorData = await response.json();
                    alert(errorData.message || '알 수 없는 오류가 발생했습니다.');
                }
            }
            catch (error)
            {
                console.error('Error:', error);
                alert('서버와의 통신 중 오류가 발생했습니다.');
            }
        }

        async function addAnswerLike(element)
        {
            const answerId = element.dataset.answerId;
            const likeCount = document.getElementById(`answer-like-count${answerId}`);
            let likeCountInt = parseInt(likeCount.textContent, 10) || 0;

            try
            {
                const response = await fetch(`/api/answer/${answerId}/likes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok)
                {
                    likeCount.textContent = ++likeCountInt;
                } else
                {
                    const errorData = await response.json();
                    alert(errorData.message || '알 수 없는 오류가 발생했습니다.');
                }
            }
            catch (error)
            {
                console.error('Error:', error);
                alert('서버와의 통신 중 오류가 발생했습니다.');
            }
        }

        async function toggleBookmark()
        {
            const postId = document.getElementById('postId').textContent;
            const bookmarkButton = document.getElementById('bookmark-button');
            const bookmarked = bookmarkButton.getAttribute('bookmarked') === 'true';
            const bookmarkIcon = document.getElementById('bookmark-icon');
            const bookmarkText = document.getElementById('bookmark-text');
            const requestUrl = `/api/bookmark/${postId}`;
            const requestMethod = bookmarked ? 'DELETE' : 'POST';

            const response = await fetch(requestUrl,
                {
                    method: requestMethod
                })

            try
            {
                if (response.ok)
                {
                    const newBookmarked = !bookmarked;
                    bookmarkButton.setAttribute('bookmarked', newBookmarked);
                    bookmarkText.textContent = newBookmarked ? '북마크 취소' : '북마크';
                    bookmarkIcon.setAttribute('data-lucide', newBookmarked ? 'bookmark-x' : 'bookmark');
                    lucide.createIcons();
                } else
                {
                    const errorData = await response.json();
                    alert(errorData.message || '알 수 없는 오류가 발생했습니다.');
                }
            }
            catch (error)
            {
                console.error('Error:', error);
                alert('서버와의 통신 중 오류가 발생했습니다.');
            }
        }

        function toggleMenu(menuId)
        {
            const menu = document.getElementById(menuId);

            if (uiState.openMenu && uiState.openMenu !== menu)
            {
                uiState.openMenu.classList.add('hidden');
            }

            menu.classList.toggle('hidden');
            uiState.openMenu = menu.classList.contains('hidden') ? null : menu;

            lucide.createIcons();
        }
    </script>
    <script src="/js/timeago.js"></script>
    <script src="/js/navigation.js"></script>
</html>
